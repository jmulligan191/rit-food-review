{% extends 'skeleton.html' %}

{# Restaurant-specific template: extends the base skeleton and provides additional fields #}

{# Macro to render 1-5 star rating as inline SVGs #}
{% macro render_stars(rating) %}
<span class="review-stars" aria-label="{{ rating }} out of 5 stars">
    {% for i in range(1,6) %}
    {% if i <= (rating|int) %} <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"
        xmlns="http://www.w3.org/2000/svg" class="star filled" aria-hidden="true">
        <path
            d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.788 1.402 8.174L12 18.896l-7.336 3.876 1.402-8.174L.132 9.21l8.2-1.192L12 .587z" />
        </svg>
        {% else %}
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
            xmlns="http://www.w3.org/2000/svg" class="star empty" aria-hidden="true">
            <path
                d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.788 1.402 8.174L12 18.896l-7.336 3.876 1.402-8.174L.132 9.21l8.2-1.192L12 .587z" />
        </svg>
        {% endif %}
        {% endfor %}
</span>
{% endmacro %}

{% block title %}{{ item.name|default('Restaurant') }} - RIT Food Review{% endblock %}

{% block banner %}
{# Prefer banner_html if provided, otherwise use item banner (inherited logic) #}
{% if banner_html is defined and banner_html %}
{{ banner_html|safe }}
{% else %}
{% if item.local_banner_path %}
{% if item.local_banner_path.startswith('http') or item.local_banner_path.startswith('//') %}
<div class="banner"><img src="{{ item.local_banner_path }}" alt="{{ item.name|default('') }} banner"
        class="img-fluid w-100 banner-img" /></div>
{% else %}
<div class="banner"><img src="{{ media_prefix }}{{ item.local_banner_path }}" alt="{{ item.name|default('') }} banner"
        class="img-fluid w-100 banner-img" /></div>
{% endif %}
{% elif item.remote_banner_url %}
<div class="banner"><img src="{{ item.remote_banner_url }}" alt="{{ item.name|default('') }} banner"
        class="img-fluid w-100 banner-img" /></div>
{% endif %}
{% endif %}
{% endblock %}

{% block content %}
<div id="content" style="margin-left: 10px; margin-top: 8px;">
    <div class="container">
        <div class="row my-3">
            <div class="col-md-3">
                {% if logo_url %}
                {% if logo_url.startswith('http') or logo_url.startswith('//') %}
                <img src="{{ logo_url }}" alt="{{ item.name }} logo" class="logo-img logo-large" />
                {% else %}
                <img src="{{ media_prefix }}{{ logo_url }}" alt="{{ item.name }} logo" class="logo-img logo-large" />
                {% endif %}
                {% elif item.local_logo_path %}
                {% if item.local_logo_path.startswith('http') or item.local_logo_path.startswith('//') %}
                <img src="{{ item.local_logo_path }}" alt="{{ item.name }} logo" class="logo-img logo-large" />
                {% else %}
                <img src="{{ media_prefix }}{{ item.local_logo_path }}" alt="{{ item.name }} logo"
                    class="logo-img logo-large" />
                {% endif %}
                {% elif item.remote_logo_url %}
                <img src="{{ item.remote_logo_url }}" alt="{{ item.name }} logo" class="logo-img logo-large" />
                {% else %}
                {# no logo provided; use placeholder passed from compiler #}
                <img src="{{ logo_placeholder }}" alt="{{ item.name }} logo" class="logo-img logo-large" />
                {% endif %}
            </div>
            <div class="col-md-9">
                <h1>{{ item.name|default('Unnamed Restaurant') }}</h1>
                <p>{{ item.description|default('No description available.') }}</p>
                {% if official_url or ordering_url %}
                <p>
                    {% if official_url %}
                    <a href="{{ official_url }}" target="_blank" rel="noopener noreferrer">Visit official page</a>
                    {% endif %}
                    {% if ordering_url %}
                    {# small separator if both links present #}
                    {% if official_url %} &nbsp;|&nbsp; {% endif %}
                    <a href="{{ ordering_url }}" target="_blank" rel="noopener noreferrer">Order online</a>
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <h4>Hours</h4>
                {% if item.hours %}
                <table class="table table-sm">
                    <tbody>
                        {% for day in ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'] %}
                        <tr>
                            <th style="width:35%">{{ day.capitalize() }}</th>
                            <td>
                                {% set v = item.hours.get(day) %}
                                {% if v is iterable and v is not string %}
                                {% for part in v %}
                                <div>{{ part }}</div>
                                {% endfor %}
                                {% else %}
                                {{ v or 'Closed' }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>No hours available.</p>
                {% endif %}
            </div>
            <div class="col-md-4">
                <h4>Contact</h4>
                {% if item.contact %}
                <p><strong>Phone:</strong> {{ item.contact.phone or 'N/A' }}</p>
                <p><strong>Email:</strong> {{ item.contact.email or 'N/A' }}</p>
                {% else %}
                <p>No contact info.</p>
                {% endif %}
                {% if item.address %}
                <p><strong>Address:</strong> {{ item.address }}</p>
                {% endif %}
                {% if item.location %}
                {% set coords = item.location.coordinates %}
                {% set has_coords = coords and (coords|length > 1) and (coords[0] is not none) and (coords[1] is not none) %}
                {% set maps_link = item.location.google_maps_url or (('https://www.google.com/maps/search/?api=1&query=' ~ coords[0] ~ ',' ~ coords[1]) if has_coords else none) %}
                {% if has_coords or maps_link %}
                <h4 class="mt-3">Location</h4>
                {% if maps_link %}
                <p>
                    <a href="{{ maps_link }}" target="_blank" rel="noopener noreferrer">View on Google Maps</a>
                    {% if has_coords %}
                        &nbsp;|&nbsp;
                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ coords[0] }},{{ coords[1] }}" target="_blank" rel="noopener noreferrer">Directions</a>
                    {% endif %}
                </p>
                {% endif %}
                {% if has_coords %}
                <div class="ratio ratio-16x9 mt-2">
                    <iframe
                        src="https://www.google.com/maps?q={{ coords[0] }},{{ coords[1] }}&z=16&output=embed"
                        width="100%" height="100%" style="border:0;" allowfullscreen=""
                        loading="lazy" referrerpolicy="no-referrer-when-downgrade"
                        title="Map for {{ item.name }}">
                    </iframe>
                </div>
                {% endif %}
                {% endif %}
                {% endif %}
            </div>
            <div class="col-md-4">
                <h4>Meta</h4>
                {% if item.tags and item.tags|length > 0 %}
                <p><strong>Tags:</strong>
                    {% for t in item.tags %}
                    <span class="badge bg-secondary">{{ t }}</span>
                    {% endfor %}
                </p>
                {% endif %}
                {% if item.payment_methods %}
                <p><strong>Payment:</strong>
                    {% for method, ok in item.payment_methods.items() %}
                    {% set pretty = method|replace('_', ' ')|title|replace('Rit', 'RIT') %}
                    {% if ok %}
                    <span class="badge bg-success text-white">{{ pretty }}</span>
                    {% else %}
                    <span class="badge bg-danger text-white">{{ pretty }}</span>
                    {% endif %}
                    {% endfor %}
                </p>
                {% endif %}
                {% if item.created_at %}
                <p><strong>Created:</strong> <time class="js-local-time" datetime="{{ item.created_at }}"
                        data-epoch="{{ item.created_at_epoch_ms|default('') }}">{{ item.created_at }}</time></p>
                {% endif %}
                {% if item.updated_at %}
                <p><strong>Updated:</strong> <time class="js-local-time" datetime="{{ item.updated_at }}"
                        data-epoch="{{ item.updated_at_epoch_ms|default('') }}">{{ item.updated_at }}</time></p>
                {% endif %}
                {% if item.created_by %}
                <p><strong>Created by:</strong> {{ item.created_by }}</p>
                {% endif %}
                {% if item.edited_by %}
                <p><strong>Edited by:</strong> {{ item.edited_by | join(', ') }}</p>
                {% endif %}
            </div>
        </div>

        {% if item.menu %}
        <div class="row my-3">
            <div class="col-12">
                <h4>Menu</h4>
                {{ item.menu|safe }}
            </div>
        </div>
        {% endif %}

        {% if extra_content is defined and extra_content %}
        {{ extra_content|safe }}
        {% endif %}

        {# Reviews: expects `reviews` to be passed as a list of review objects keyed by slug in reviews.jsonc #}
        {% if reviews is defined and reviews|length > 0 %}
        <div class="row my-3">
            <div class="col-12">
                <h4>Reviews ({{ reviews|length }})</h4>
                {% for r in reviews %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex">
                            <div class="me-3">
                                {% if r.author_image_url %}
                                {% if r.author_image_url.startswith('http') or r.author_image_url.startswith('//') %}
                                <img src="{{ r.author_image_url }}" class="rounded-circle" alt="{{ r.author }} avatar"
                                    style="width:48px;height:48px;object-fit:cover;">
                                {% else %}
                                <img src="{{ media_prefix }}{{ r.author_image_url }}" class="rounded-circle"
                                    alt="{{ r.author }} avatar" style="width:48px;height:48px;object-fit:cover;">
                                {% endif %}
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-1">{{ r.author or 'Anonymous' }} <small class="text-muted"> ‚Äî {{ r.date
                                        }}</small></h5>
                                <div class="mb-2">{{ render_stars(r.rating|int) }}</div>
                                <p class="mb-1">{{ r.description }}</p>
                                {% if r.attachment_url %}
                                {% if r.attachment_url.startswith('http') or r.attachment_url.startswith('//') %}
                                <img src="{{ r.attachment_url }}" alt="review attachment" class="img-fluid mt-2"
                                    style="max-width:240px;">
                                {% else %}
                                <img src="{{ media_prefix }}{{ r.attachment_url }}" alt="review attachment"
                                    class="img-fluid mt-2" style="max-width:240px;">
                                {% endif %}
                                {% endif %}
                                <p class="mt-2 text-muted small">üëç {{ r.upvotes or 0 }} &nbsp; üëé {{ r.downvotes or 0
                                    }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}